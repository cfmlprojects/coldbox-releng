<project name="distro.build" default="build" basedir="./" xmlns:antcontrib="antlib:net.sf.antcontrib">

	<loadproperties srcfile="build.properties"/>
	<import file="${cfdistro.build.file}"/>
	<property name="coldbox.src.dir" location="${src.dir}/coldbox" />

	<target name="coldbox.getversion">
		<tstamp prefix="start"/>
		<property name="build.number" value="${start.DSTAMP}${start.TSTAMP}"/>
		<loadfile srcFile="${src.dir}/coldbox/system/web/config/Settings.cfc" property="coldbox.version"/>
		<antcontrib:propertyregex override="yes" property="coldbox.version" input="${coldbox.version}" 
			regexp=".*?this.version\s+?=\s+?&quot;([^&quot;]+).*?" select="\1" />
		<antcontrib:propertyregex override="yes" property="coldbox.version" input="${coldbox.version}" 
			regexp="@build.number@" replace="${build.number}" />
		<echo message="ColdBox Version: ${coldbox.version}" />
	</target>

	<target name="build" depends="cfdistro.build">
		<mapping physical="@src.dir@/coldbox" virtual="/coldbox"/>
	</target>

	<target name="test">
		<server-run> 
		<!--
			<get
				src="http://${server.host}:${server.port.http}/coldbox/testharness/index.cfm"
				retries="3" ignoreerrors="true"
				dest="${temp.dir}/firedUpNowDelMe.html" />
				-->
			<testbox-rundirs basePath="${src.dir}/coldbox/testing/cases/" componentPath="coldbox.testing.cases" outputdir="${dist.dir}/testresults/"/>
		</server-run>
	</target>

	<target name="build.test" depends="build">
		<!-- temporarily turn off secondary cache as railo has a bug
		 -->
		<replaceregexp file="${src.dir}/coldbox/testing/Application.cfc" match="secondarycacheenabled = true" replace="secondarycacheenabled = false" byline="false" flags="g,s"/>
		<dependency groupId="org.coldspringframework" artifactId="coldspring" version="1.2" mapping="/coldspring" />
		<copy todir="${war.target.dir}">
			<fileset dir="${src.dir}/coldbox/testharness/" />
		</copy>
		<railo-cache name="def-obj" class="railo.runtime.cache.eh.EHCache" storage="true" 
			default-type="default-object"
	    	custom="${cache.props}"/>

		<railo-cache name="def-tmpl" class="railo.runtime.cache.eh.EHCache" storage="true" 
			default-type="default-template"
	    	custom="${cache.props}"/>

		<railo-cache name="def-qry" class="railo.runtime.cache.eh.EHCache" storage="true" 
			default-type="default-query"
	    	custom="${cache.props}"/>

		<server-run> 
		<!--
			<get
				src="http://${server.host}:${server.port.http}/coldbox/testharness/index.cfm"
				retries="3" ignoreerrors="true"
				dest="${temp.dir}/firedUpNowDelMe.html" />
				-->
			<testbox-rundirs basePath="${src.dir}/coldbox/testing/cases/" componentPath="coldbox.testing.cases" outputdir="${dist.dir}/testresults/"/>
		</server-run>
	</target>

	<target name="build.mockbox" depends="coldbox.getversion">
		<property name="mockbox.build.dir" location="${dist.dir}/mockbox/" />
		<property name="mockbox.version" value="${coldbox.version}"/>
		<property name="build.label" value="mockbox-buildID-${start.DSTAMP}${start.TSTAMP}"/>
      	<delete dir="${mockbox.build.dir}" />
      	<mkdir dir="${mockbox.build.dir}" />

		<concat destfile="${mockbox.build.dir}/${build.label}">Built on ${start.TODAY}</concat>
		<!-- Copy src to mockbox namespace -->	
      	<copy todir="${mockbox.build.dir}/mockbox/system">
        	<fileset dir="${coldbox.src.dir}/system" includes="core/** testing/**" />
        </copy>
		<!-- Copy src to coldbox namespace -->
      	<copy todir="${mockbox.build.dir}/coldbox/system">
        	<fileset dir="${coldbox.src.dir}/system" includes="core/** testing/**" />
        </copy>

		<echo>Refactoring for coldbox absolute paths</echo>
		<replace dir="${mockbox.build.dir}" value="/mockbox/system/" summary="yes"
			includes="**/*.cfc **/*.cfm **/*.xml">
			<replacetoken>/coldbox/system/</replacetoken>
		</replace>
		<echo>Refactoring for coldbox instantitation and cfc paths</echo>
		<replace dir="${mockbox.build.dir}" value="mockbox.system." summary="yes"
			includes="**/*.cfc **/*.cfm **/*.xml">
			<replacetoken>coldbox.system.</replacetoken>
		</replace>
		<!--Copy text files to root folder-->
		<copy todir="${mockbox.build.dir}/">
			<fileset dir="${coldbox.src.dir}" includes="license.txt system/testing/readme.txt" />
		</copy>

		<!-- Execute ColdDoc -->
		<colddoc packagenames="mockbox"  
			sourcepath="${mockbox.build.dir}" destdir="${mockbox.build.dir}/api" 
			title="MockBox ${mockbox.version}" />

		<!-- Zip Bundle -->
		<zip destfile="${dist.dir}/mockbox_${mockbox.version}.zip" basedir="${mockbox.build.dir}/mockbox"></zip>
	</target>

	<target name="build.testbox">
		<property name="testbox.build.dir" location="${dist.dir}/testbox/" />
		<tstamp prefix="start"/>
		<property name="testbox.version" value="1.1.0"/>
		<property name="build.number" value="${start.DSTAMP}${start.TSTAMP}"/>
		<property name="build.label" value="testbox-buildID-${build.number}"/>
      	<delete dir="${testbox.build.dir}" />
      	<mkdir dir="${testbox.build.dir}" />

		<!-- Copy src to TestBox namespace -->	
      	<copy todir="${testbox.build.dir}/testbox/system/testing">
        	<fileset dir="${coldbox.src.dir}/system/testing" />
        </copy>
		<copy todir="${testbox.build.dir}/testbox/system/core/dynamic">
        	<fileset dir="${coldbox.src.dir}/system/core/dynamic" />
        </copy>
		<copy todir="${testbox.build.dir}/testbox/system/core/util">
        	<fileset dir="${coldbox.src.dir}/system/core/util" />
        </copy>
		<copy todir="${testbox.build.dir}/testbox/system/core/conversion">
        	<fileset dir="${coldbox.src.dir}/system/core/conversion" />
        </copy>
		<copy todir="${testbox.build.dir}/runner-template">
        	<fileset dir="${coldbox.src.dir}/ApplicationTemplates/testbox-runner" />
        </copy>
		<copy todir="${testbox.build.dir}/runner">
        	<fileset dir="${coldbox.src.dir}/test-runner" />
        </copy>
        <copy todir="${testbox.build.dir}/browser">
        	<fileset dir="${coldbox.src.dir}/test-browser" />
        </copy>
		<copy todir="${testbox.build.dir}/samples">
        	<fileset dir="${coldbox.src.dir}/testing/cases/testing">
        		<exclude name="**/BaseTestCaseTest.cfc" />
        	</fileset>
        </copy>
		
		<!-- cleanup coldbox platform specific stuff -->
		<delete dir="${testbox.build.dir}/testbox/system/testing/mock" />
		<delete file="${testbox.build.dir}/testbox/system/testing/BaseHandlerTest.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/testing/BaseInterceptorTest.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/testing/BaseModelTest.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/testing/BasePluginTest.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/core/util/Validator.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/core/util/Zip.cfc" />
		<delete file="${testbox.build.dir}/testbox/system/core/util/RequestBuffer.cfc" />
		
		<!--Copy text files to root folder-->
		<copy todir="${testbox.build.dir}/">
			<fileset file="${coldbox.src.dir}/license.txt" />
			<fileset file="${coldbox.src.dir}/system/testing/mockbox.txt" />
			<fileset file="${coldbox.src.dir}/system/testing/testbox.txt" />
		</copy>
		
		<!-- Replace Build Numbers -->
		<replaceregexp match='@build.number@' replace="${build.number}" flags="ig" byline="true">
		  <fileset dir="${testbox.build.dir}">
		  </fileset>
		</replaceregexp>
						
		<echo>Refactoring for coldbox absolute paths</echo>
		<replace dir="${testbox.build.dir}" value="/testbox/system/" summary="yes">
		  	<include name="**/*.cfc" />
			<include name="**/*.cfm" />
			<include name="**/*.xml" />
			<replacetoken>/coldbox/system/</replacetoken>
		</replace>
		
		<echo>Refactoring for testbox instantitation and cfc paths</echo>
		<replace dir="${testbox.build.dir}" value="testbox.system." summary="yes">
		  	<include name="**/*.cfc" />
			<include name="**/*.cfm" />
			<include name="**/*.xml" />
			<replacetoken>coldbox.system.</replacetoken>
		</replace>
		
		<!-- Execute ColdDoc -->
		<colddoc packagenames="testbox"  
			sourcepath="${testbox.build.dir}" destdir="${testbox.build.dir}/apidocs" 
			title="TestBox ${testbox.version}" />

		<!-- Zip API Docs -->
		<zip destfile="${dist.dir}/TestBoxDocs-${testbox.version}.zip" basedir="${testbox.build.dir}/apidocs"></zip>
				
		<!-- Zip Bundle -->
		<zip destfile="${dist.dir}/testbox_${testbox.version}.zip" basedir="${testbox.build.dir}/testbox"></zip>
		<zip destfile="${dist.dir}/testbox-all_${testbox.version}.zip" basedir="${testbox.build.dir}"></zip>
		
		<!-- Cleanup -->
		<delete dir="${testbox.build.dir}" />
	</target>


	<target name="build.mvn.release" depends="project.update, build.test, coldbox.getversion, build.mockbox, build.testbox">
	    <property name="mvn.repo.dest" value="local" />
	    <property name="mvn.repo.dest" value="remote" />
	    <property name="mvn.repo.id" value="mvn.repo.${mvn.repo.dest}" />
	    <property name="maven.repo.local" location="${cfdistro.basedir}/artifacts" />
		<mvn-repo id="mvn.repo.local" url="file://${maven.repo.local}/" />
	   	<property name="mvn.type" value="release" />

	   	<delete file="${dist.dir}/coldbox.zip" />
	   	<delete file="${dist.dir}/coldbox-all.zip" />
		<zip destfile="${dist.dir}/coldbox.zip" basedir="${src.dir}/coldbox/" 
			excludes="testing/** testharness/** ApplicationTemplates/** install/** ant/**" />
		<zip destfile="${dist.dir}/coldbox-all.zip" basedir="${src.dir}/coldbox/"/>

		<pom-and-deploy pomid="coldbox.pom" packaging="zip" artifact="${dist.dir}/coldbox.zip"
		 groupId="org.coldbox" artifactId="coldbox" version="${coldbox.version}" name="coldbox"/>
		<pom-and-deploy pomid="coldbox-all.pom" packaging="zip" artifact="${dist.dir}/coldbox-all.zip"
		 groupId="org.coldbox" artifactId="coldbox-all" version="${coldbox.version}" name="coldbox-all"/>
		<pom-and-deploy pomid="mockbox.pom" packaging="zip" artifact="${dist.dir}/mockbox_${mockbox.version}.zip"
		 groupId="org.coldbox" artifactId="mockbox" version="${mockbox.version}" name="mockbox"/>
		<pom-and-deploy pomid="testbox.pom" packaging="zip" artifact="${dist.dir}/testbox_${testbox.version}.zip"
		 groupId="org.coldbox" artifactId="testbox" version="${testbox.version}" name="testbox"/>
		<pom-and-deploy pomid="testboxall.pom" packaging="zip" artifact="${dist.dir}/testbox-all_${testbox.version}.zip"
		 groupId="org.coldbox" artifactId="testbox-all" version="${testbox.version}" name="testbox-all"/>
		
	 	<!--  create an extension -->
		<delete dir="${basedir}/extensionbase/" />
		<mkdir dir="${basedir}/extensionbase/" />
		<copy todir="${basedir}/extensionbase/applications/coldbox">
			<fileset dir="${src.dir}/coldbox" />
		</copy>
		<antcontrib:runtarget target="extension.build" />
		<delete dir="${basedir}/extensionbase/" />
	
        <!-- add the extension as well -->
		<mvn-put artifact="${extension.dist}/${extension.archive}"
			packaging="zip" repoId="${mvn.repo.id}" groupId="cfml.extensions"
			artifactId="coldbox" version="${extension.version}" />

	</target>



		
</project>
